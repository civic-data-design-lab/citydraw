<!DOCTYPE html>
<!--Based on https://github.com/mjfoster83/web-map-workshop/blob/master/7_advancedMapping_CartoDB/index-completed.html-->
<html>
  <head>
    <title>Leaflet to CartoDB - Point Collection Tool Beta</title>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
    <link rel="stylesheet" href="http://leaflet.github.io/Leaflet.draw/leaflet.draw.css" />
    <link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
    <!-- Custom CSS -->
    <link href="css/simple-sidebar.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="css/style.css">
  </head>
  <body>
    <div id="wrapper">
            <div id="sidebar-wrapper">
            <ul class="sidebar-nav">
                <li class="sidebar-brand">
                    <a href="#">
                        Draw your City
                    </a>
                </li>
				<li><a href="#">Add your Home</a><li><input type="text" name="FirstName" value="Home Address"></li></li>
				<li><a href="#">Add your Work</a>
				<li><input type="text" name="FirstName" value="Work Address"></li></li>
				<li><a href="#">Drawing Tools</a>
				<ul>
				<li><a href="#" onclick="drawMarker()" value="Click to Start Editing">Draw Marker</a></li>
				<li><a href="#" onclick="drawLine()" value="Click to Start Editing">Draw Path</a></li>
				<li><a href="#" onclick="drawPolygon()" value="Click to Start Editing">Draw Polygon</a></li>
				</ul>
				</li>
<!-- 
				<li>
					<div id="btnBar" class="noMouse">
						<div id="startPolyBtn" class="yesMouse"><i class="glyphicon glyphicon-pencil icon-white"></i>Draw a Polygon</div>
						<div id="startMarkerBtn" class="yesMouse"><i class="glyphicon glyphicon-pushpin icon-white"></i>Mark a Point</div>
						<div id="deletePolyBtn" style:""  class="btn btn-default  yesMouse" type="button"> <i class="glyphicon glyphicon-trash icon-white"> </i> Cancel</div>
						<div id="submitPolyBtn" style="display:none;" class="btn btn-default btn-success  yesMouse" type="button">Save Neighborhood</div>
					</div>
				</li>
 -->
                <li>
			<a href="#">Basemap Layers</a>
			<ul>
				<li id="addStreets"><a href="#">Streets</a></li>
				<li id="addBuildings"><a href="#">Buildings</a></li>
				<li id="addWaterbody"><a href="#">Waterbodies</a></li>
				</li>
			</ul>
            </ul>
        </div>
      <div id="header">
        <h1>Leaflet Draw  Collection Tool</h1>
      </div>
      <div id="map"></div>
      <div id="controls">
        <a href="#menu-toggle" class="btn btn-default" id="menu-toggle">Toggle Menu</a>
        <div id="credits"><p>&copy;2015, Mike Foster and Raphael Dumas</p></div>
      </div>
    </div>

    <div id="dialog" title="Tell us About this Drawing">     
      <form>
        <fieldset style="border: none;">
          <ul style="list-style-type: none; padding-left: 0px">
            <li><label for="username">Your Name</label></li>
            <li><input type="text" name="username" id="username" placeholder="Enter your name" class="text ui-widget-content ui-corner-all"></li>
            <li><label for="description">About this</label></li>
            <li><input type="text" name="description" id="description" placeholder="Description for this point" class="text ui-widget-content ui-corner-all"></li>
          </ul>
          <input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
        </fieldset>
      </form>
    </div>

    <script src='https://api.mapbox.com/mapbox.js/v2.3.0/mapbox.js'></script>
    <script src="http://leaflet.github.io/Leaflet.draw/leaflet.draw.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
    <script>
    	L.mapbox.accessToken = 'pk.eyJ1IjoibWl0Y2l2aWNkYXRhIiwiYSI6ImNpbDQ0aGR0djN3MGl1bWtzaDZrajdzb28ifQ.quOF41LsLB5FdjnGLwbrrg';

		//TODO: Change to your username, insert function on cartodb, and cartodb tablename
		var config = {
			cartoDBusername : "mjfoster83",
			cartoDBinsertfunction : "insert_crowd_mapping_data",
			cartoDBtablename : "crowdmap_basic",
			mapcenter: [42.354865, -71.065840],
			drawOptions: {
				position: 'topright',
				draw : {
					polygon : true,
					polyline : true,
					rectangle : true,
					/*Circles aren't supported by the GeoJSON spec, so won't get sent to the database properly. 
					*http://stackoverflow.com/a/16944309/4047679
					*/
					circle : false,
					marker: true
				},
				edit : false,
				remove: false
			}
		};
		
		var geocoder = L.mapbox.geocoder('mapbox.places');
		
		// Basemaps
		$.getJSON("data/centerlines.geojson",function(data){
			centerlines = L.mapbox.tileLayer('mitcivicdata.cambridge_streets');
		});
		$.getJSON("data/buildings.geojson",function(data){
			buildings = L.mapbox.tileLayer('mitcivicdata.Basemap');
		});
		$.getJSON("data/waterbodies.geojson",function(data){
			waterbodies = L.mapbox.tileLayer('mitcivicdata.cambridge_hydro');
		});

		// load GeoJSON from an external file
		$( "#addStreets" ).click(function() {
			if(map.hasLayer(centerlines)){
				map.removeLayer(centerlines);
			} else {
				centerlines.addTo(map);
			};
		});

		$( "#addBuildings" ).click(function() {
			if(map.hasLayer(buildings)){
				map.removeLayer(buildings);
			} else {
				buildings.addTo(map);
			};
		});

		$( "#addWaterbody" ).click(function() {
			if(map.hasLayer(waterbodies)){
				map.removeLayer(waterbodies);
			} else {
				waterbodies.addTo(map);
			};
		});


		// Add Data from CartoDB using the SQL API
		// Declare Variables
		// Create Global Variable to hold CartoDB points
		var cartoDBData = null;

		// Write SQL Selection Query to be Used on CartoDB Table
		var sqlQuery = "SELECT the_geom, description, name FROM " + config.cartoDBtablename;


		// Create Leaflet map object
		var map = L.map('map', { center: config.mapcenter, zoom: 14, zoomControl: false});
		// Add Tile Layer basemap
		// Find your own at https://leaflet-extras.github.io/leaflet-providers/preview/
		var CartoDB_Positron = L.tileLayer('http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
			attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',
			subdomains: 'abcd',
			maxZoom: 19
		});

		// CartoDB_Positron.addTo(map);

		//Fetches
		var getData = "https://" + config.cartoDBusername + ".cartodb.com/api/v2/sql?format=GeoJSON&q=" + sqlQuery;

		function getGeoJSON() {
			$.getJSON(getData, function (data) {
				cartoDBData = L.geoJson(data, {
					onEachFeature: function (feature, layer) {
						layer.bindPopup('' + feature.properties.description + '<br>Submitted by ' + feature.properties.name + '');
					}
				}).addTo(map);
			});
		}

		getGeoJSON();

		var drawnItems = new L.FeatureGroup();

		var drawControl = new L.Control.Draw(config.drawOptions);
		var controlOnMap = false;
		function startEdits() {
			if (controlOnMap === true) {
				map.removeControl(drawControl);
				controlOnMap = false;
			}
			map.addControl(drawControl);
			controlOnMap = true;
		}
		function stopEdits() {
			map.removeControl(drawControl);
			controlOnMap = false;
		}
		
		function toggleEdits() {
			if (controlOnMap === true) {
				map.removeControl(drawControl);
				controlOnMap = false;
			} else {
				map.addControl(drawControl);
				controlOnMap = true;
			}
		}
		
		function drawLine() {
			new L.Draw.Polyline(map, drawControl.options.polyline).enable();
		}
		
		function drawMarker() {
			new L.Draw.Marker(map, drawControl.options.marker).enable()
		}
		
		function drawPolygon() {
			new L.Draw.Polygon(map, drawControl.options.polygon).enable()
		}
		
		function drawRectangle() {
			new L.Draw.Rectangle(map, drawControl.options.rectangle).enable()
		}
		
		map.on('draw:created', function (e) {
			var layer = e.layer;
			map.addLayer(drawnItems);
			drawnItems.addLayer(layer);
			dialog.dialog("open");
		});
		
		var dialog = $("#dialog").dialog({
			autoOpen: false,
			height: 300,
			width: 350,
			modal: true,
			position: {
				my: "center center",
				at: "center center",
				of: "#map"
			},
			buttons: {
				"Add to Database": setData,
				Cancel: function () {
					dialog.dialog("close");
					refreshLayer();				
				}
			},
			close: function () {
				form[0].reset();
				refreshLayer();
				console.log("Dialog closed");
			}
		});

		form = dialog.find("form").on("submit", function (event) {
			event.preventDefault();
			setData();
		});

		function setData() {
			var enteredUsername = "'" + username.value + "'",
				enteredDescription = "'" + description.value + "'";
			drawnItems.eachLayer(function (layer) {
			//Convert the drawing to a GeoJSON to pass to the CartoDB sql database
				var drawing = "'" + JSON.stringify(layer.toGeoJSON().geometry) + "'",

				//Construct the SQL query to insert data from the three parameters: the drawing, the input username, and the input description of the drawn shape
				sql = "SELECT " + config.cartoDBinsertfunction + "(";
				sql += drawing;
				sql += "," + enteredDescription;
				sql += "," + enteredUsername;
				sql += ");";

				console.log(drawing);
				console.log(sql);

				//Sending the data
				$.ajax({
					type: 'POST',
					url: 'https://' + config.cartoDBusername + '.cartodb.com/api/v2/sql',
					crossDomain: true,
					data: {"q": sql},
					dataType: 'json',
					success: function (responseData, textStatus, jqXHR) {
						console.log("Data saved");
					},
					error: function (responseData, textStatus, errorThrown) {
						console.log("Problem saving the data");
					}
				});

				/* 
				* Transfer submitted drawing to the CartoDB layer, this results in the user's data appearing on the map without
				* requerying the database (see the refreshLayer() function for an alternate way of doing this) 
				*/
				var newData = layer.toGeoJSON();
				  newData.properties.description = description.value;
				  newData.properties.name = username.value;

				cartoDBData.addData(newData);

			});
			
			dialog.dialog("close");
		}
		function refreshLayer() {
			console.log("drawnItems has been cleared");
			map.removeLayer(drawnItems);
			drawnItems = new L.FeatureGroup();
		/* 
			This would refresh the data-layer to include new data from the CartoDB table after each drawing is submitted. 
		*/
		//      if (map.hasLayer(cartoDBData)) {
		//        map.removeLayer(cartoDBData);
		//      };
		//      getGeoJSON();
		}
		
		new L.Control.Zoom({ position: 'topright' }).addTo(map);
		
		$("#menu-toggle").click(function(e) {
			e.preventDefault();
			$("#wrapper").toggleClass("toggled");
		});
    </script>
  </body>
</html>

